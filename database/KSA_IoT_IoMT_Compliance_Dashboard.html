<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KSA IoT/IoMT Healthcare Compliance Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header .subtitle {
            font-size: 1.2em;
            opacity: 0.9;
            margin-bottom: 20px;
        }

        .meta-info {
            display: flex;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .meta-badge {
            background: rgba(255,255,255,0.2);
            padding: 10px 20px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }

        .tabs {
            display: flex;
            background: #f5f5f5;
            border-bottom: 2px solid #ddd;
            overflow-x: auto;
        }

        .tab {
            padding: 20px 30px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .tab:hover {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
        }

        .tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }

        .content {
            padding: 40px;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-number {
            font-size: 3em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .filter-bar {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-bar input,
        .filter-bar select {
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            flex: 1;
            min-width: 200px;
        }

        .filter-bar input:focus,
        .filter-bar select:focus {
            outline: none;
            border-color: #667eea;
        }

        .controls-grid {
            display: grid;
            gap: 20px;
        }

        .control-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 25px;
            transition: all 0.3s;
        }

        .control-card:hover {
            border-color: #667eea;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.2);
            transform: translateY(-2px);
        }

        .control-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .control-id {
            background: #667eea;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
        }

        .control-family {
            background: #f0f0f0;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            color: #666;
        }

        .control-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }

        .control-domain {
            color: #666;
            font-size: 0.95em;
            margin-bottom: 15px;
            font-style: italic;
        }

        .control-meta {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .meta-tag {
            background: #f5f5f5;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            color: #555;
        }

        .instruments-list {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .instrument-badge {
            background: #e3f2fd;
            color: #1976d2;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .regulators-list {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .regulator-badge {
            background: #fff3e0;
            color: #e65100;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .evidence-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .evidence-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .evidence-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .evidence-table tr:hover {
            background: #f9f9f9;
        }

        .domain-section {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .domain-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #667eea;
        }

        .domain-title {
            font-size: 1.5em;
            font-weight: 600;
            color: #667eea;
        }

        .domain-count {
            background: #667eea;
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: bold;
        }

        .regulator-section {
            background: white;
            border-left: 5px solid #667eea;
            padding: 25px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .regulator-name {
            font-size: 1.4em;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }

        .regulator-desc {
            color: #666;
            margin-bottom: 15px;
        }

        .instrument-list {
            display: grid;
            gap: 10px;
            margin-top: 15px;
        }

        .instrument-item {
            background: #f9f9f9;
            padding: 12px;
            border-radius: 8px;
            border-left: 3px solid #667eea;
        }

        .instrument-code {
            font-weight: 600;
            color: #667eea;
            margin-right: 10px;
        }

        .type-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .type-preventive { background: #c8e6c9; color: #2e7d32; }
        .type-detective { background: #fff9c4; color: #f57f17; }
        .type-corrective { background: #ffccbc; color: #d84315; }

        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            background: #e3f2fd;
            color: #1976d2;
        }

        .search-highlight {
            background: yellow;
            font-weight: bold;
        }

        .legend {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 10px;
            margin-top: 30px;
        }

        .legend-title {
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }

        .legend-items {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .control-card.selected {
            border-color: #667eea;
            background: #f0f4ff;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.3);
        }

        .control-card input[type="checkbox"] {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .selection-toolbar {
            background: #667eea;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .selection-toolbar.active {
            display: flex;
        }

        .toolbar-btn {
            background: white;
            color: #667eea;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .toolbar-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .sortable {
            cursor: pointer;
            user-select: none;
            position: relative;
            padding-right: 20px;
        }

        .sortable:hover {
            background: rgba(255,255,255,0.1);
        }

        .sortable::after {
            content: '‚áÖ';
            position: absolute;
            right: 5px;
            opacity: 0.5;
        }

        .sortable.asc::after {
            content: '‚ñ≤';
            opacity: 1;
        }

        .sortable.desc::after {
            content: '‚ñº';
            opacity: 1;
        }

        .pivot-container {
            margin-top: 30px;
        }

        .pivot-controls {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .pivot-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .pivot-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s;
        }

        .pivot-card:hover {
            border-color: #667eea;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.2);
        }

        .pivot-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
            margin: 10px 0;
        }

        .pivot-label {
            font-size: 1.1em;
            color: #666;
            font-weight: 600;
        }

        .pivot-sublabel {
            font-size: 0.9em;
            color: #999;
            margin-top: 5px;
        }

        .advanced-filters {
            background: #f0f4ff;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .filter-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .filter-label {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            display: block;
        }

        .multi-select {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .multi-select-item {
            background: white;
            border: 2px solid #ddd;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
        }

        .multi-select-item:hover {
            border-color: #667eea;
        }

        .multi-select-item.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .export-menu {
            position: relative;
            display: inline-block;
        }

        .export-dropdown {
            display: none;
            position: absolute;
            background: white;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            border-radius: 8px;
            padding: 10px;
            z-index: 1000;
            min-width: 150px;
            top: 100%;
            left: 0;
            margin-top: 5px;
        }

        .export-dropdown.show {
            display: block;
        }

        .export-option {
            padding: 10px 15px;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.3s;
        }

        .export-option:hover {
            background: #f0f4ff;
            color: #667eea;
        }

        @media print {
            body {
                background: white;
                padding: 0;
            }
            .tabs { display: none; }
            .filter-bar { display: none; }
            .selection-toolbar { display: none !important; }
            .tab-content { display: block !important; }
        }

        @media (max-width: 768px) {
            .header h1 { font-size: 1.8em; }
            .content { padding: 20px; }
            .stat-number { font-size: 2em; }
            .filter-bar { flex-direction: column; }
            .filter-bar input, .filter-bar select { min-width: 100%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üè• KSA IoT/IoMT Healthcare Compliance Dashboard</h1>
            <div class="subtitle">Comprehensive Compliance Framework for Saudi Arabia Healthcare Systems</div>
            <div class="meta-info">
                <div class="meta-badge">üìÖ Generated: November 4, 2025</div>
                <div class="meta-badge">üåç Jurisdiction: Saudi Arabia</div>
                <div class="meta-badge">üìã Version: 1.0</div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('overview')">üìä Overview</button>
            <button class="tab" onclick="showTab('controls')">üîí Controls (36)</button>
            <button class="tab" onclick="showTab('evidence')">üìÅ Evidence Catalog (72)</button>
            <button class="tab" onclick="showTab('pivot')">üìà Pivot Analysis</button>
            <button class="tab" onclick="showTab('domains')">üéØ Domains (12)</button>
            <button class="tab" onclick="showTab('regulators')">üèõÔ∏è Regulators</button>
            <button class="tab" onclick="showTab('instruments')">üìú Instruments</button>
            <button class="tab" onclick="showTab('mapping')">üîó Control-Evidence Mapping</button>
        </div>

        <!-- Content -->
        <div class="content">
            <!-- Overview Tab -->
            <div id="overview" class="tab-content active">
                <h2 style="margin-bottom: 30px; color: #333;">üìä Compliance Framework Overview</h2>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number">36</div>
                        <div class="stat-label">Total Controls</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">72</div>
                        <div class="stat-label">Evidence Items</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">12</div>
                        <div class="stat-label">Domain Families</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">5</div>
                        <div class="stat-label">Regulatory Bodies</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">11</div>
                        <div class="stat-label">Instruments/Standards</div>
                    </div>
                </div>

                <div class="domain-section">
                    <h3 style="color: #333; margin-bottom: 20px;">üìã Domain Distribution</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
                        <div style="background: #f5f5f5; padding: 15px; border-radius: 8px;">
                            <strong>GOV</strong> - Governance & Risk <span style="float: right; color: #667eea; font-weight: bold;">3 controls</span>
                        </div>
                        <div style="background: #f5f5f5; padding: 15px; border-radius: 8px;">
                            <strong>PRIV</strong> - Privacy & PDPL <span style="float: right; color: #667eea; font-weight: bold;">3 controls</span>
                        </div>
                        <div style="background: #f5f5f5; padding: 15px; border-radius: 8px;">
                            <strong>IOT</strong> - IoT/Device Security <span style="float: right; color: #667eea; font-weight: bold;">3 controls</span>
                        </div>
                        <div style="background: #f5f5f5; padding: 15px; border-radius: 8px;">
                            <strong>NET</strong> - Network & Zero Trust <span style="float: right; color: #667eea; font-weight: bold;">3 controls</span>
                        </div>
                        <div style="background: #f5f5f5; padding: 15px; border-radius: 8px;">
                            <strong>IDAM</strong> - Identity & Access <span style="float: right; color: #667eea; font-weight: bold;">3 controls</span>
                        </div>
                        <div style="background: #f5f5f5; padding: 15px; border-radius: 8px;">
                            <strong>LOG</strong> - Logging & Monitoring <span style="float: right; color: #667eea; font-weight: bold;">3 controls</span>
                        </div>
                        <div style="background: #f5f5f5; padding: 15px; border-radius: 8px;">
                            <strong>VULN</strong> - Vulnerability Mgmt <span style="float: right; color: #667eea; font-weight: bold;">3 controls</span>
                        </div>
                        <div style="background: #f5f5f5; padding: 15px; border-radius: 8px;">
                            <strong>HIE</strong> - Health Info Exchange <span style="float: right; color: #667eea; font-weight: bold;">3 controls</span>
                        </div>
                        <div style="background: #f5f5f5; padding: 15px; border-radius: 8px;">
                            <strong>OT</strong> - OT/Clinical Network <span style="float: right; color: #667eea; font-weight: bold;">3 controls</span>
                        </div>
                        <div style="background: #f5f5f5; padding: 15px; border-radius: 8px;">
                            <strong>DATA</strong> - Data Lifecycle <span style="float: right; color: #667eea; font-weight: bold;">3 controls</span>
                        </div>
                        <div style="background: #f5f5f5; padding: 15px; border-radius: 8px;">
                            <strong>SUP</strong> - Supplier & Market <span style="float: right; color: #667eea; font-weight: bold;">3 controls</span>
                        </div>
                        <div style="background: #f5f5f5; padding: 15px; border-radius: 8px;">
                            <strong>IR</strong> - Incident Response <span style="float: right; color: #667eea; font-weight: bold;">3 controls</span>
                        </div>
                    </div>
                </div>

                <div class="domain-section">
                    <h3 style="color: #333; margin-bottom: 20px;">üé≠ Control Type Distribution</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                        <div style="text-align: center; padding: 20px;">
                            <div style="font-size: 3em; color: #2e7d32;">üõ°Ô∏è</div>
                            <div style="font-size: 2em; font-weight: bold; color: #2e7d32;">24</div>
                            <div>Preventive Controls</div>
                        </div>
                        <div style="text-align: center; padding: 20px;">
                            <div style="font-size: 3em; color: #f57f17;">üîç</div>
                            <div style="font-size: 2em; font-weight: bold; color: #f57f17;">6</div>
                            <div>Detective Controls</div>
                        </div>
                        <div style="text-align: center; padding: 20px;">
                            <div style="font-size: 3em; color: #d84315;">üîß</div>
                            <div style="font-size: 2em; font-weight: bold; color: #d84315;">6</div>
                            <div>Corrective Controls</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Controls Tab -->
            <div id="controls" class="tab-content">
                <h2 style="margin-bottom: 20px; color: #333;">üîí Control Framework (36 Controls)</h2>
                
                <!-- Selection Toolbar -->
                <div id="selectionToolbar" class="selection-toolbar">
                    <span id="selectionCount"><strong>0</strong> controls selected</span>
                    <button class="toolbar-btn" onclick="selectAll()">‚úì Select All</button>
                    <button class="toolbar-btn" onclick="deselectAll()">‚úó Deselect All</button>
                    <div class="export-menu">
                        <button class="toolbar-btn" onclick="toggleExportMenu()">üì• Export Selected</button>
                        <div id="exportDropdown" class="export-dropdown">
                            <div class="export-option" onclick="exportSelected('json')">üìÑ JSON</div>
                            <div class="export-option" onclick="exportSelected('csv')">üìä CSV</div>
                            <div class="export-option" onclick="exportSelected('txt')">üìù Text</div>
                        </div>
                    </div>
                    <button class="toolbar-btn" onclick="compareSelected()">üîç Compare Selected</button>
                </div>

                <!-- Advanced Filters -->
                <div class="advanced-filters">
                    <h3 style="margin-bottom: 15px; color: #333;">üéØ Advanced Filters</h3>
                    
                    <div class="filter-bar">
                        <input type="text" id="controlSearch" placeholder="üîç Search controls..." onkeyup="filterControls()">
                        <select id="sortControl" onchange="sortControls()">
                            <option value="">Sort By...</option>
                            <option value="id">Control ID</option>
                            <option value="family">Family</option>
                            <option value="type">Type</option>
                            <option value="title">Title</option>
                        </select>
                    </div>

                    <div style="margin-top: 15px;">
                        <label class="filter-label">Filter by Family:</label>
                        <div class="multi-select" id="familyMultiSelect"></div>
                    </div>

                    <div style="margin-top: 15px;">
                        <label class="filter-label">Filter by Type:</label>
                        <div class="multi-select" id="typeMultiSelect"></div>
                    </div>

                    <div style="margin-top: 15px;">
                        <label class="filter-label">Filter by Regulator:</label>
                        <div class="multi-select" id="regulatorMultiSelect"></div>
                    </div>

                    <button class="toolbar-btn" onclick="resetFilters()" style="margin-top: 15px;">üîÑ Reset All Filters</button>
                </div>

                <div id="controlsList" class="controls-grid"></div>
            </div>

            <!-- Evidence Tab -->
            <div id="evidence" class="tab-content">
                <h2 style="margin-bottom: 20px; color: #333;">üìÅ Evidence Catalog (72 Items)</h2>
                
                <div class="filter-bar">
                    <input type="text" id="evidenceSearch" placeholder="üîç Search evidence..." onkeyup="filterEvidence()">
                    <select id="evidenceTypeFilter" onchange="filterEvidence()">
                        <option value="">All Types</option>
                        <option value="Policy">Policy</option>
                        <option value="Config/Log/Report">Config/Log/Report</option>
                    </select>
                    <select id="evidenceRegulatorFilter" onchange="filterEvidence()">
                        <option value="">All Regulators</option>
                        <option value="NCA">NCA</option>
                        <option value="SDAIA/NDMO">SDAIA/NDMO</option>
                        <option value="SFDA">SFDA</option>
                        <option value="SHC/MoH/CHI">SHC/MoH/CHI</option>
                        <option value="CST">CST</option>
                    </select>
                    <button class="toolbar-btn" onclick="exportEvidence()">üì• Export Table</button>
                </div>

                <div style="overflow-x: auto;">
                    <table id="evidenceTable" class="evidence-table">
                        <thead>
                            <tr>
                                <th class="sortable" onclick="sortEvidenceTable(0)">Evidence ID</th>
                                <th class="sortable" onclick="sortEvidenceTable(1)">Title</th>
                                <th class="sortable" onclick="sortEvidenceTable(2)">Control ID</th>
                                <th class="sortable" onclick="sortEvidenceTable(3)">Type</th>
                                <th class="sortable" onclick="sortEvidenceTable(4)">Regulator</th>
                                <th class="sortable" onclick="sortEvidenceTable(5)">Instrument</th>
                                <th class="sortable" onclick="sortEvidenceTable(6)">Owner</th>
                            </tr>
                        </thead>
                        <tbody id="evidenceTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Pivot Analysis Tab -->
            <div id="pivot" class="tab-content">
                <h2 style="margin-bottom: 20px; color: #333;">üìà Pivot Analysis & Insights</h2>
                
                <div class="pivot-controls">
                    <h3 style="margin-bottom: 15px; color: #333;">üìä Analysis Dimensions</h3>
                    <div class="filter-bar">
                        <select id="pivotDimension" onchange="updatePivot()">
                            <option value="family">By Family</option>
                            <option value="type">By Control Type</option>
                            <option value="regulator">By Regulator</option>
                            <option value="instrument">By Instrument</option>
                            <option value="owner">By Owner Role</option>
                        </select>
                        <select id="pivotMetric" onchange="updatePivot()">
                            <option value="count">Count</option>
                            <option value="evidence">Evidence Items</option>
                            <option value="percentage">Percentage</option>
                        </select>
                        <button class="toolbar-btn" onclick="exportPivot()">üì• Export Analysis</button>
                    </div>
                </div>

                <div id="pivotResults" class="pivot-container"></div>
            </div>

            <!-- Domains Tab -->
            <div id="domains" class="tab-content">
                <h2 style="margin-bottom: 20px; color: #333;">üéØ Domain Families (12 Domains)</h2>
                <div id="domainsList"></div>
            </div>

            <!-- Regulators Tab -->
            <div id="regulators" class="tab-content">
                <h2 style="margin-bottom: 20px; color: #333;">üèõÔ∏è Regulatory Bodies</h2>
                <div id="regulatorsList"></div>
            </div>

            <!-- Instruments Tab -->
            <div id="instruments" class="tab-content">
                <h2 style="margin-bottom: 20px; color: #333;">üìú Regulatory Instruments & Standards</h2>
                <div id="instrumentsList"></div>
            </div>

            <!-- Mapping Tab -->
            <div id="mapping" class="tab-content">
                <h2 style="margin-bottom: 20px; color: #333;">üîó Control-Evidence Mapping</h2>
                <p style="color: #666; margin-bottom: 30px;">Visual mapping showing the relationship between controls and their evidence requirements.</p>
                <div id="mappingView"></div>
            </div>
        </div>
    </div>

    <script>
        // Data from JSON
        const checklistData = {
  "meta": {
    "name": "KSA IoT/IoMT Healthcare Compliance Checklist (Seed)",
    "version": "1.0",
    "generated": "2025-11-04",
    "jurisdiction": "Saudi Arabia",
    "regulators": {
      "NCA": "National Cybersecurity Authority",
      "SDAIA/NDMO": "Saudi Data & AI Authority / National Data Management Office",
      "CST": "Communications, Space & Technology Commission",
      "SFDA": "Saudi Food & Drug Authority",
      "SHC/MoH/CHI": "Saudi Health Council / Ministry of Health / Council of Health Insurance"
    },
    "instruments": {
      "PDPL": "PDPL Law + Implementing Regulations (SDAIA/NDMO)",
      "NCA-IoT": "NCA IoT Cybersecurity Guidelines (2024)",
      "NCA-OTCC": "NCA Operational Technology Cybersecurity Controls",
      "NCA-ECC": "NCA Essential Cybersecurity Controls (Enterprise baseline)",
      "CST-IoT": "CST IoT Regulatory Framework & Guidelines (+device certification)",
      "HIE-SEC": "SHC/NHIC HIE Security, Consent, Identity & Audit Policies",
      "NHIC-SecPriv": "NHIC eHealth Security & Privacy Standard",
      "NPHIES": "CHI/NPHIES integration & security expectations",
      "SFDA-Pre": "SFDA Pre-market Cybersecurity (medical devices)",
      "SFDA-Post": "SFDA Post-market Cybersecurity (vuln mgmt/updates)",
      "SFDA-Provider": "SFDA Provider Cybersecurity Guidance (healthcare providers)"
    },
    "domains": {
      "GOV": "Governance & Risk",
      "PRIV": "Privacy & PDPL",
      "IOT": "IoT/Device Security (firmware, crypto, OTA)",
      "NET": "Network, Segmentation & Zero Trust",
      "IDAM": "Identity & Access Management",
      "LOG": "Logging, Monitoring & Audit",
      "VULN": "Vulnerability & Patch Management",
      "HIE": "Health Information Exchange (Consent & Audit)",
      "OT": "OT/Clinical Network Protections",
      "DATA": "Data Lifecycle & Localization",
      "SUP": "Supplier & Market Access (CST/SFDA)",
      "IR": "Incident/Breach Response & PDPL Notifications"
    }
  },
  "controls": [
    {"id":"C-001","family":"GOV","title":"ISMS governance established (scope includes IoT/IoMT)","domain":"Governance & Risk","type":"Preventive","instruments":["NCA-ECC","NCA-IoT"],"regulators":["NCA"],"expected_evidence":2,"owner_role":"CISO/Head of Clinical Engineering","review_frequency":"Annual","status":"Planned"},
    {"id":"C-002","family":"GOV","title":"Risk assessment for IoT/IoMT and HIE interfaces (annual)","domain":"Governance & Risk","type":"Detective","instruments":["NCA-IoT","HIE-SEC"],"regulators":["NCA","SHC/MoH/CHI"],"expected_evidence":2,"owner_role":"CISO/Head of Clinical Engineering","review_frequency":"Annual","status":"Planned"},
    {"id":"C-003","family":"GOV","title":"Third-line assurance / internal audit over IoT controls","domain":"Governance & Risk","type":"Detective","instruments":["NCA-ECC"],"regulators":["NCA"],"expected_evidence":2,"owner_role":"CISO/Head of Clinical Engineering","review_frequency":"Annual","status":"Planned"},
    {"id":"C-004","family":"PRIV","title":"PDPL lawful basis & consent model for patient telemetry","domain":"Privacy & PDPL","type":"Preventive","instruments":["PDPL","HIE-SEC"],"regulators":["SDAIA/NDMO","SHC/MoH/CHI"],"expected_evidence":2,"owner_role":"CISO/Head of Clinical Engineering","review_frequency":"Annual","status":"Planned"},
    {"id":"C-005","family":"PRIV","title":"DPIA for connected devices & cross-border flows","domain":"Privacy & PDPL","type":"Detective","instruments":["PDPL"],"regulators":["SDAIA/NDMO"],"expected_evidence":2,"owner_role":"CISO/Head of Clinical Engineering","review_frequency":"Annual","status":"Planned"},
    {"id":"C-006","family":"PRIV","title":"DSR handling (access, rectification, deletion) incl. device data","domain":"Privacy & PDPL","type":"Corrective","instruments":["PDPL"],"regulators":["SDAIA/NDMO"],"expected_evidence":2,"owner_role":"CISO/Head of Clinical Engineering","review_frequency":"Annual","status":"Planned"},
    {"id":"C-007","family":"IOT","title":"Secure boot, code signing, and measured boot for devices","domain":"IoT/Device Security (firmware, crypto, OTA)","type":"Preventive","instruments":["NCA-IoT","SFDA-Pre"],"regulators":["NCA","SFDA"],"expected_evidence":2,"owner_role":"CISO/Head of Clinical Engineering","review_frequency":"Annual","status":"Planned"},
    {"id":"C-008","family":"IOT","title":"Cryptography (TLS/mTLS, at-rest, keys in HSM/SE)","domain":"IoT/Device Security (firmware, crypto, OTA)","type":"Preventive","instruments":["NCA-IoT"],"regulators":["NCA"],"expected_evidence":2,"owner_role":"CISO/Head of Clinical Engineering","review_frequency":"Annual","status":"Planned"},
    {"id":"C-009","family":"IOT","title":"OTA updates with rollback & SBOM-based impact analysis","domain":"IoT/Device Security (firmware, crypto, OTA)","type":"Corrective","instruments":["NCA-IoT","SFDA-Post"],"regulators":["NCA","SFDA"],"expected_evidence":2,"owner_role":"CISO/Head of Clinical Engineering","review_frequency":"Annual","status":"Planned"},
    {"id":"C-010","family":"NET","title":"Network zoning for IoMT (patient, clinical, admin, guest)","domain":"Network, Segmentation & Zero Trust","type":"Preventive","instruments":["NCA-OTCC","NCA-IoT"],"regulators":["NCA"],"expected_evidence":2,"owner_role":"CISO/Head of Clinical Engineering","review_frequency":"Annual","status":"Planned"},
    {"id":"C-011","family":"NET","title":"Gateway allowlists & egress filtering for device traffic","domain":"Network, Segmentation & Zero Trust","type":"Preventive","instruments":["NCA-IoT"],"regulators":["NCA"],"expected_evidence":2,"owner_role":"CISO/Head of Clinical Engineering","review_frequency":"Annual","status":"Planned"},
    {"id":"C-012","family":"NET","title":"Zero Trust access between device, platform, cloud","domain":"Network, Segmentation & Zero Trust","type":"Preventive","instruments":["NCA-IoT","NCA-ECC"],"regulators":["NCA"],"expected_evidence":2,"owner_role":"CISO/Head of Clinical Engineering","review_frequency":"Annual","status":"Planned"},
    {"id":"C-013","family":"IDAM","title":"Unique identities for devices & services (cert-based)","domain":"Identity & Access Management","type":"Preventive","instruments":["NCA-IoT"],"regulators":["NCA"],"expected_evidence":2,"owner_role":"CISO/Head of Clinical Engineering","review_frequency":"Annual","status":"Planned"},
    {"id":"C-014","family":"IDAM","title":"MFA & least-privilege for admins of IoMT platforms","domain":"Identity & Access Management","type":"Preventive","instruments":["NCA-ECC"],"regulators":["NCA"],"expected_evidence":2,"owner_role":"CISO/Head of Clinical Engineering","review_frequency":"Annual","status":"Planned"},
    {"id":"C-015","family":"IDAM","title":"Just-in-time privileged access with session recording","domain":"Identity & Access Management","type":"Detective","instruments":["NCA-ECC"],"regulators":["NCA"],"expected_evidence":2,"owner_role":"CISO/Head of Clinical Engineering","review_frequency":"Annual","status":"Planned"},
    {"id":"C-016","family":"LOG","title":"Device/platform security logs centralized (SIEM)","domain":"Logging, Monitoring & Audit","type":"Detective","instruments":["NCA-IoT"],"regulators":["NCA"],"expected_evidence":2,"owner_role":"CISO/Head of Clinical Engineering","review_frequency":"Annual","status":"Planned"},
    {"id":"C-017","family":"LOG","title":"Clinical audit trails (who accessed which record)","domain":"Logging, Monitoring & Audit","type":"Detective","instruments":["HIE-SEC","NHIC-SecPriv"],"regulators":["SHC/MoH/CHI"],"expected_evidence":2,"owner_role":"CISO/Head of Clinical Engineering","review_frequency":"Annual","status":"Planned"},
    {"id":"C-018","family":"LOG","title":"Time sync/NTP hardening across IoMT estate","domain":"Logging, Monitoring & Audit","type":"Preventive","instruments":["NCA-IoT"],"regulators":["NCA"],"expected_evidence":2,"owner_role":"CISO/Head of Clinical Engineering","review_frequency":"Annual","status":"Planned"},
    {"id":"C-019","family":"VULN","title":"SBOM management & SCA for device firmware/apps","domain":"Vulnerability & Patch Management","type":"Detective","instruments":["NCA-IoT","SFDA-Pre"],"regulators":["NCA","SFDA"],"expected_evidence":2,"owner_role":"CISO/Head of Clinical Engineering","review_frequency":"Annual","status":"Planned"},
    {"id":"C-020","family":"VULN","title":"Routine VA & prioritized patching (risk-based SLAs)","domain":"Vulnerability & Patch Management","type":"Corrective","instruments":["NCA-ECC"],"regulators":["NCA"],"expected_evidence":2,"owner_role":"CISO/Head of Clinical Engineering","review_frequency":"Annual","status":"Planned"},
    {"id":"C-021","family":"VULN","title":"Coordinated vulnerability disclosure process","domain":"Vulnerability & Patch Management","type":"Corrective","instruments":["SFDA-Post"],"regulators":["SFDA"],"expected_evidence":2,"owner_role":"CISO/Head of Clinical Engineering","review_frequency":"Annual","status":"Planned"},
    {"id":"C-022","family":"HIE","title":"Consent capture & enforcement for data sharing","domain":"Health Information Exchange (Consent & Audit)","type":"Preventive","instruments":["HIE-SEC","PDPL"],"regulators":["SHC/MoH/CHI","SDAIA/NDMO"],"expected_evidence":2,"owner_role":"CISO/Head of Clinical Engineering","review_frequency":"Annual","status":"Planned"},
    {"id":"C-023","family":"HIE","title":"NPHIES integration security (claims/eligibility)","domain":"Health Information Exchange (Consent & Audit)","type":"Preventive","instruments":["NPHIES"],"regulators":["SHC/MoH/CHI"],"expected_evidence":2,"owner_role":"CISO/Head of Clinical Engineering","review_frequency":"Annual","status":"Planned"},
    {"id":"C-024","family":"HIE","title":"End-to-end message protection & non-repudiation","domain":"Health Information Exchange (Consent & Audit)","type":"Preventive","instruments":["HIE-SEC"],"regulators":["SHC/MoH/CHI"],"expected_evidence":2,"owner_role":"CISO/Head of Clinical Engineering","review_frequency":"Annual","status":"Planned"},
    {"id":"C-025","family":"OT","title":"Asset inventory for clinical/OT devices (incl. IoMT)","domain":"OT/Clinical Network Protections","type":"Detective","instruments":["NCA-OTCC"],"regulators":["NCA"],"expected_evidence":2,"owner_role":"CISO/Head of Clinical Engineering","review_frequency":"Annual","status":"Planned"},
    {"id":"C-026","family":"OT","title":"Segmentation firewalls & jump hosts for maintenance","domain":"OT/Clinical Network Protections","type":"Preventive","instruments":["NCA-OTCC"],"regulators":["NCA"],"expected_evidence":2,"owner_role":"CISO/Head of Clinical Engineering","review_frequency":"Annual","status":"Planned"},
    {"id":"C-027","family":"OT","title":"Change control for clinical systems touching IoMT","domain":"OT/Clinical Network Protections","type":"Preventive","instruments":["NCA-OTCC","NCA-ECC"],"regulators":["NCA"],"expected_evidence":2,"owner_role":"CISO/Head of Clinical Engineering","review_frequency":"Annual","status":"Planned"},
    {"id":"C-028","family":"DATA","title":"Data classification incl. sensor telemetry & PHI","domain":"Data Lifecycle & Localization","type":"Preventive","instruments":["PDPL"],"regulators":["SDAIA/NDMO"],"expected_evidence":2,"owner_role":"CISO/Head of Clinical Engineering","review_frequency":"Annual","status":"Planned"},
    {"id":"C-029","family":"DATA","title":"Localization & cross-border transfer register","domain":"Data Lifecycle & Localization","type":"Detective","instruments":["PDPL"],"regulators":["SDAIA/NDMO"],"expected_evidence":2,"owner_role":"CISO/Head of Clinical Engineering","review_frequency":"Annual","status":"Planned"},
    {"id":"C-030","family":"DATA","title":"Backup/DR for IoMT platforms & HIE bridges","domain":"Data Lifecycle & Localization","type":"Corrective","instruments":["NCA-ECC"],"regulators":["NCA"],"expected_evidence":2,"owner_role":"CISO/Head of Clinical Engineering","review_frequency":"Annual","status":"Planned"},
    {"id":"C-031","family":"SUP","title":"CST device approval/type certification evidence on file","domain":"Supplier & Market Access (CST/SFDA)","type":"Preventive","instruments":["CST-IoT"],"regulators":["CST"],"expected_evidence":2,"owner_role":"CISO/Head of Clinical Engineering","review_frequency":"Annual","status":"Planned"},
    {"id":"C-032","family":"SUP","title":"Supplier security clauses (SBOM, updates, vuln SLAs)","domain":"Supplier & Market Access (CST/SFDA)","type":"Preventive","instruments":["NCA-IoT","SFDA-Pre"],"regulators":["NCA","SFDA"],"expected_evidence":2,"owner_role":"CISO/Head of Clinical Engineering","review_frequency":"Annual","status":"Planned"},
    {"id":"C-033","family":"SUP","title":"eSIM/NB-IoT profiles managed & auditable","domain":"Supplier & Market Access (CST/SFDA)","type":"Detective","instruments":["CST-IoT"],"regulators":["CST"],"expected_evidence":2,"owner_role":"CISO/Head of Clinical Engineering","review_frequency":"Annual","status":"Planned"},
    {"id":"C-034","family":"IR","title":"24/7 incident response runbook for IoMT scenarios","domain":"Incident/Breach Response & PDPL Notifications","type":"Corrective","instruments":["NCA-ECC"],"regulators":["NCA"],"expected_evidence":2,"owner_role":"CISO/Head of Clinical Engineering","review_frequency":"Annual","status":"Planned"},
    {"id":"C-035","family":"IR","title":"Breach assessment & PDPL notification workflow","domain":"Incident/Breach Response & PDPL Notifications","type":"Corrective","instruments":["PDPL"],"regulators":["SDAIA/NDMO"],"expected_evidence":2,"owner_role":"CISO/Head of Clinical Engineering","review_frequency":"Annual","status":"Planned"},
    {"id":"C-036","family":"IR","title":"Post-incident lessons learned & control tuning","domain":"Incident/Breach Response & PDPL Notifications","type":"Corrective","instruments":["NCA-ECC"],"regulators":["NCA"],"expected_evidence":2,"owner_role":"CISO/Head of Clinical Engineering","review_frequency":"Annual","status":"Planned"}
  ]
};

        // Evidence data (CSV parsed)
        const evidenceData = [
  {id:"E-001",title:"ISMS governance established (scope includes IoT/IoMT) - Evidence 1",control:"C-001",type:"Policy",regulator:"NCA",instrument:"NCA-ECC",owner:"Security Governance"},
  {id:"E-002",title:"ISMS governance established (scope includes IoT/IoMT) - Evidence 2",control:"C-001",type:"Config/Log/Report",regulator:"NCA",instrument:"NCA-ECC",owner:"SecOps/Clinical Eng."},
  {id:"E-003",title:"Risk assessment for IoT/IoMT and HIE interfaces (annual) - Evidence 1",control:"C-002",type:"Policy",regulator:"NCA",instrument:"NCA-IoT",owner:"Security Governance"},
  {id:"E-004",title:"Risk assessment for IoT/IoMT and HIE interfaces (annual) - Evidence 2",control:"C-002",type:"Config/Log/Report",regulator:"NCA",instrument:"NCA-IoT",owner:"SecOps/Clinical Eng."},
  {id:"E-005",title:"Third-line assurance / internal audit over IoT controls - Evidence 1",control:"C-003",type:"Policy",regulator:"NCA",instrument:"NCA-ECC",owner:"Security Governance"},
  {id:"E-006",title:"Third-line assurance / internal audit over IoT controls - Evidence 2",control:"C-003",type:"Config/Log/Report",regulator:"NCA",instrument:"NCA-ECC",owner:"SecOps/Clinical Eng."},
  {id:"E-007",title:"PDPL lawful basis & consent model for patient telemetry - Evidence 1",control:"C-004",type:"Policy",regulator:"SDAIA/NDMO",instrument:"PDPL",owner:"Security Governance"},
  {id:"E-008",title:"PDPL lawful basis & consent model for patient telemetry - Evidence 2",control:"C-004",type:"Config/Log/Report",regulator:"SDAIA/NDMO",instrument:"PDPL",owner:"SecOps/Clinical Eng."},
  {id:"E-009",title:"DPIA for connected devices & cross-border flows - Evidence 1",control:"C-005",type:"Policy",regulator:"SDAIA/NDMO",instrument:"PDPL",owner:"Security Governance"},
  {id:"E-010",title:"DPIA for connected devices & cross-border flows - Evidence 2",control:"C-005",type:"Config/Log/Report",regulator:"SDAIA/NDMO",instrument:"PDPL",owner:"SecOps/Clinical Eng."},
  {id:"E-011",title:"DSR handling (access, rectification, deletion) incl. device data - Evidence 1",control:"C-006",type:"Policy",regulator:"SDAIA/NDMO",instrument:"PDPL",owner:"Security Governance"},
  {id:"E-012",title:"DSR handling (access, rectification, deletion) incl. device data - Evidence 2",control:"C-006",type:"Config/Log/Report",regulator:"SDAIA/NDMO",instrument:"PDPL",owner:"SecOps/Clinical Eng."},
  {id:"E-013",title:"Secure boot, code signing, and measured boot for devices - Evidence 1",control:"C-007",type:"Policy",regulator:"NCA",instrument:"NCA-IoT",owner:"Security Governance"},
  {id:"E-014",title:"Secure boot, code signing, and measured boot for devices - Evidence 2",control:"C-007",type:"Config/Log/Report",regulator:"NCA",instrument:"NCA-IoT",owner:"SecOps/Clinical Eng."},
  {id:"E-015",title:"Cryptography (TLS/mTLS, at-rest, keys in HSM/SE) - Evidence 1",control:"C-008",type:"Policy",regulator:"NCA",instrument:"NCA-IoT",owner:"Security Governance"},
  {id:"E-016",title:"Cryptography (TLS/mTLS, at-rest, keys in HSM/SE) - Evidence 2",control:"C-008",type:"Config/Log/Report",regulator:"NCA",instrument:"NCA-IoT",owner:"SecOps/Clinical Eng."},
  {id:"E-017",title:"OTA updates with rollback & SBOM-based impact analysis - Evidence 1",control:"C-009",type:"Policy",regulator:"NCA",instrument:"NCA-IoT",owner:"Security Governance"},
  {id:"E-018",title:"OTA updates with rollback & SBOM-based impact analysis - Evidence 2",control:"C-009",type:"Config/Log/Report",regulator:"NCA",instrument:"NCA-IoT",owner:"SecOps/Clinical Eng."},
  {id:"E-019",title:"Network zoning for IoMT (patient, clinical, admin, guest) - Evidence 1",control:"C-010",type:"Policy",regulator:"NCA",instrument:"NCA-OTCC",owner:"Security Governance"},
  {id:"E-020",title:"Network zoning for IoMT (patient, clinical, admin, guest) - Evidence 2",control:"C-010",type:"Config/Log/Report",regulator:"NCA",instrument:"NCA-OTCC",owner:"SecOps/Clinical Eng."},
  {id:"E-021",title:"Gateway allowlists & egress filtering for device traffic - Evidence 1",control:"C-011",type:"Policy",regulator:"NCA",instrument:"NCA-IoT",owner:"Security Governance"},
  {id:"E-022",title:"Gateway allowlists & egress filtering for device traffic - Evidence 2",control:"C-011",type:"Config/Log/Report",regulator:"NCA",instrument:"NCA-IoT",owner:"SecOps/Clinical Eng."},
  {id:"E-023",title:"Zero Trust access between device, platform, cloud - Evidence 1",control:"C-012",type:"Policy",regulator:"NCA",instrument:"NCA-IoT",owner:"Security Governance"},
  {id:"E-024",title:"Zero Trust access between device, platform, cloud - Evidence 2",control:"C-012",type:"Config/Log/Report",regulator:"NCA",instrument:"NCA-IoT",owner:"SecOps/Clinical Eng."},
  {id:"E-025",title:"Unique identities for devices & services (cert-based) - Evidence 1",control:"C-013",type:"Policy",regulator:"NCA",instrument:"NCA-IoT",owner:"Security Governance"},
  {id:"E-026",title:"Unique identities for devices & services (cert-based) - Evidence 2",control:"C-013",type:"Config/Log/Report",regulator:"NCA",instrument:"NCA-IoT",owner:"SecOps/Clinical Eng."},
  {id:"E-027",title:"MFA & least-privilege for admins of IoMT platforms - Evidence 1",control:"C-014",type:"Policy",regulator:"NCA",instrument:"NCA-ECC",owner:"Security Governance"},
  {id:"E-028",title:"MFA & least-privilege for admins of IoMT platforms - Evidence 2",control:"C-014",type:"Config/Log/Report",regulator:"NCA",instrument:"NCA-ECC",owner:"SecOps/Clinical Eng."},
  {id:"E-029",title:"Just-in-time privileged access with session recording - Evidence 1",control:"C-015",type:"Policy",regulator:"NCA",instrument:"NCA-ECC",owner:"Security Governance"},
  {id:"E-030",title:"Just-in-time privileged access with session recording - Evidence 2",control:"C-015",type:"Config/Log/Report",regulator:"NCA",instrument:"NCA-ECC",owner:"SecOps/Clinical Eng."},
  {id:"E-031",title:"Device/platform security logs centralized (SIEM) - Evidence 1",control:"C-016",type:"Policy",regulator:"NCA",instrument:"NCA-IoT",owner:"Security Governance"},
  {id:"E-032",title:"Device/platform security logs centralized (SIEM) - Evidence 2",control:"C-016",type:"Config/Log/Report",regulator:"NCA",instrument:"NCA-IoT",owner:"SecOps/Clinical Eng."},
  {id:"E-033",title:"Clinical audit trails (who accessed which record) - Evidence 1",control:"C-017",type:"Policy",regulator:"SHC/MoH/CHI",instrument:"HIE-SEC",owner:"Security Governance"},
  {id:"E-034",title:"Clinical audit trails (who accessed which record) - Evidence 2",control:"C-017",type:"Config/Log/Report",regulator:"SHC/MoH/CHI",instrument:"HIE-SEC",owner:"SecOps/Clinical Eng."},
  {id:"E-035",title:"Time sync/NTP hardening across IoMT estate - Evidence 1",control:"C-018",type:"Policy",regulator:"NCA",instrument:"NCA-IoT",owner:"Security Governance"},
  {id:"E-036",title:"Time sync/NTP hardening across IoMT estate - Evidence 2",control:"C-018",type:"Config/Log/Report",regulator:"NCA",instrument:"NCA-IoT",owner:"SecOps/Clinical Eng."},
  {id:"E-037",title:"SBOM management & SCA for device firmware/apps - Evidence 1",control:"C-019",type:"Policy",regulator:"NCA",instrument:"NCA-IoT",owner:"Security Governance"},
  {id:"E-038",title:"SBOM management & SCA for device firmware/apps - Evidence 2",control:"C-019",type:"Config/Log/Report",regulator:"NCA",instrument:"NCA-IoT",owner:"SecOps/Clinical Eng."},
  {id:"E-039",title:"Routine VA & prioritized patching (risk-based SLAs) - Evidence 1",control:"C-020",type:"Policy",regulator:"NCA",instrument:"NCA-ECC",owner:"Security Governance"},
  {id:"E-040",title:"Routine VA & prioritized patching (risk-based SLAs) - Evidence 2",control:"C-020",type:"Config/Log/Report",regulator:"NCA",instrument:"NCA-ECC",owner:"SecOps/Clinical Eng."},
  {id:"E-041",title:"Coordinated vulnerability disclosure process - Evidence 1",control:"C-021",type:"Policy",regulator:"SFDA",instrument:"SFDA-Post",owner:"Security Governance"},
  {id:"E-042",title:"Coordinated vulnerability disclosure process - Evidence 2",control:"C-021",type:"Config/Log/Report",regulator:"SFDA",instrument:"SFDA-Post",owner:"SecOps/Clinical Eng."},
  {id:"E-043",title:"Consent capture & enforcement for data sharing - Evidence 1",control:"C-022",type:"Policy",regulator:"SHC/MoH/CHI",instrument:"HIE-SEC",owner:"Security Governance"},
  {id:"E-044",title:"Consent capture & enforcement for data sharing - Evidence 2",control:"C-022",type:"Config/Log/Report",regulator:"SHC/MoH/CHI",instrument:"HIE-SEC",owner:"SecOps/Clinical Eng."},
  {id:"E-045",title:"NPHIES integration security (claims/eligibility) - Evidence 1",control:"C-023",type:"Policy",regulator:"SHC/MoH/CHI",instrument:"NPHIES",owner:"Security Governance"},
  {id:"E-046",title:"NPHIES integration security (claims/eligibility) - Evidence 2",control:"C-023",type:"Config/Log/Report",regulator:"SHC/MoH/CHI",instrument:"NPHIES",owner:"SecOps/Clinical Eng."},
  {id:"E-047",title:"End-to-end message protection & non-repudiation - Evidence 1",control:"C-024",type:"Policy",regulator:"SHC/MoH/CHI",instrument:"HIE-SEC",owner:"Security Governance"},
  {id:"E-048",title:"End-to-end message protection & non-repudiation - Evidence 2",control:"C-024",type:"Config/Log/Report",regulator:"SHC/MoH/CHI",instrument:"HIE-SEC",owner:"SecOps/Clinical Eng."},
  {id:"E-049",title:"Asset inventory for clinical/OT devices (incl. IoMT) - Evidence 1",control:"C-025",type:"Policy",regulator:"NCA",instrument:"NCA-OTCC",owner:"Security Governance"},
  {id:"E-050",title:"Asset inventory for clinical/OT devices (incl. IoMT) - Evidence 2",control:"C-025",type:"Config/Log/Report",regulator:"NCA",instrument:"NCA-OTCC",owner:"SecOps/Clinical Eng."},
  {id:"E-051",title:"Segmentation firewalls & jump hosts for maintenance - Evidence 1",control:"C-026",type:"Policy",regulator:"NCA",instrument:"NCA-OTCC",owner:"Security Governance"},
  {id:"E-052",title:"Segmentation firewalls & jump hosts for maintenance - Evidence 2",control:"C-026",type:"Config/Log/Report",regulator:"NCA",instrument:"NCA-OTCC",owner:"SecOps/Clinical Eng."},
  {id:"E-053",title:"Change control for clinical systems touching IoMT - Evidence 1",control:"C-027",type:"Policy",regulator:"NCA",instrument:"NCA-OTCC",owner:"Security Governance"},
  {id:"E-054",title:"Change control for clinical systems touching IoMT - Evidence 2",control:"C-027",type:"Config/Log/Report",regulator:"NCA",instrument:"NCA-OTCC",owner:"SecOps/Clinical Eng."},
  {id:"E-055",title:"Data classification incl. sensor telemetry & PHI - Evidence 1",control:"C-028",type:"Policy",regulator:"SDAIA/NDMO",instrument:"PDPL",owner:"Security Governance"},
  {id:"E-056",title:"Data classification incl. sensor telemetry & PHI - Evidence 2",control:"C-028",type:"Config/Log/Report",regulator:"SDAIA/NDMO",instrument:"PDPL",owner:"SecOps/Clinical Eng."},
  {id:"E-057",title:"Localization & cross-border transfer register - Evidence 1",control:"C-029",type:"Policy",regulator:"SDAIA/NDMO",instrument:"PDPL",owner:"Security Governance"},
  {id:"E-058",title:"Localization & cross-border transfer register - Evidence 2",control:"C-029",type:"Config/Log/Report",regulator:"SDAIA/NDMO",instrument:"PDPL",owner:"SecOps/Clinical Eng."},
  {id:"E-059",title:"Backup/DR for IoMT platforms & HIE bridges - Evidence 1",control:"C-030",type:"Policy",regulator:"NCA",instrument:"NCA-ECC",owner:"Security Governance"},
  {id:"E-060",title:"Backup/DR for IoMT platforms & HIE bridges - Evidence 2",control:"C-030",type:"Config/Log/Report",regulator:"NCA",instrument:"NCA-ECC",owner:"SecOps/Clinical Eng."},
  {id:"E-061",title:"CST device approval/type certification evidence on file - Evidence 1",control:"C-031",type:"Policy",regulator:"CST",instrument:"CST-IoT",owner:"Security Governance"},
  {id:"E-062",title:"CST device approval/type certification evidence on file - Evidence 2",control:"C-031",type:"Config/Log/Report",regulator:"CST",instrument:"CST-IoT",owner:"SecOps/Clinical Eng."},
  {id:"E-063",title:"Supplier security clauses (SBOM, updates, vuln SLAs) - Evidence 1",control:"C-032",type:"Policy",regulator:"NCA",instrument:"NCA-IoT",owner:"Security Governance"},
  {id:"E-064",title:"Supplier security clauses (SBOM, updates, vuln SLAs) - Evidence 2",control:"C-032",type:"Config/Log/Report",regulator:"NCA",instrument:"NCA-IoT",owner:"SecOps/Clinical Eng."},
  {id:"E-065",title:"eSIM/NB-IoT profiles managed & auditable - Evidence 1",control:"C-033",type:"Policy",regulator:"CST",instrument:"CST-IoT",owner:"Security Governance"},
  {id:"E-066",title:"eSIM/NB-IoT profiles managed & auditable - Evidence 2",control:"C-033",type:"Config/Log/Report",regulator:"CST",instrument:"CST-IoT",owner:"SecOps/Clinical Eng."},
  {id:"E-067",title:"24/7 incident response runbook for IoMT scenarios - Evidence 1",control:"C-034",type:"Policy",regulator:"NCA",instrument:"NCA-ECC",owner:"Security Governance"},
  {id:"E-068",title:"24/7 incident response runbook for IoMT scenarios - Evidence 2",control:"C-034",type:"Config/Log/Report",regulator:"NCA",instrument:"NCA-ECC",owner:"SecOps/Clinical Eng."},
  {id:"E-069",title:"Breach assessment & PDPL notification workflow - Evidence 1",control:"C-035",type:"Policy",regulator:"SDAIA/NDMO",instrument:"PDPL",owner:"Security Governance"},
  {id:"E-070",title:"Breach assessment & PDPL notification workflow - Evidence 2",control:"C-035",type:"Config/Log/Report",regulator:"SDAIA/NDMO",instrument:"PDPL",owner:"SecOps/Clinical Eng."},
  {id:"E-071",title:"Post-incident lessons learned & control tuning - Evidence 1",control:"C-036",type:"Policy",regulator:"NCA",instrument:"NCA-ECC",owner:"Security Governance"},
  {id:"E-072",title:"Post-incident lessons learned & control tuning - Evidence 2",control:"C-036",type:"Config/Log/Report",regulator:"NCA",instrument:"NCA-ECC",owner:"SecOps/Clinical Eng."}
];

        // Global state
        let selectedControls = new Set();
        let activeFilters = {
            families: new Set(),
            types: new Set(),
            regulators: new Set()
        };
        let sortDirection = {};

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            initializeFilters();
            renderControls();
            renderEvidence();
            renderDomains();
            renderRegulators();
            renderInstruments();
            renderMapping();
            updatePivot();
        });

        // Tab navigation
        function showTab(tabName) {
            const tabs = document.querySelectorAll('.tab');
            const contents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(tab => tab.classList.remove('active'));
            contents.forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        // Initialize filters
        function initializeFilters() {
            // Family filters
            const families = [...new Set(checklistData.controls.map(c => c.family))];
            document.getElementById('familyMultiSelect').innerHTML = families.map(f => 
                `<div class="multi-select-item" onclick="toggleFilter('family', '${f}')" data-value="${f}">${f}</div>`
            ).join('');

            // Type filters
            const types = [...new Set(checklistData.controls.map(c => c.type))];
            document.getElementById('typeMultiSelect').innerHTML = types.map(t => 
                `<div class="multi-select-item" onclick="toggleFilter('type', '${t}')" data-value="${t}">${t}</div>`
            ).join('');

            // Regulator filters
            const regulators = [...new Set(checklistData.controls.flatMap(c => c.regulators))];
            document.getElementById('regulatorMultiSelect').innerHTML = regulators.map(r => 
                `<div class="multi-select-item" onclick="toggleFilter('regulator', '${r}')" data-value="${r}">${r}</div>`
            ).join('');
        }

        // Toggle filter
        function toggleFilter(type, value) {
            const filterSet = type === 'family' ? activeFilters.families : 
                            type === 'type' ? activeFilters.types : 
                            activeFilters.regulators;
            
            if (filterSet.has(value)) {
                filterSet.delete(value);
            } else {
                filterSet.add(value);
            }

            // Update UI
            const selector = type === 'family' ? 'familyMultiSelect' : 
                           type === 'type' ? 'typeMultiSelect' : 
                           'regulatorMultiSelect';
            const items = document.querySelectorAll(`#${selector} .multi-select-item`);
            items.forEach(item => {
                if (item.dataset.value === value) {
                    item.classList.toggle('selected');
                }
            });

            filterControls();
        }

        // Reset filters
        function resetFilters() {
            activeFilters.families.clear();
            activeFilters.types.clear();
            activeFilters.regulators.clear();
            document.querySelectorAll('.multi-select-item').forEach(item => {
                item.classList.remove('selected');
            });
            document.getElementById('controlSearch').value = '';
            filterControls();
        }

        // Render controls
        function renderControls() {
            const container = document.getElementById('controlsList');
            container.innerHTML = checklistData.controls.map(control => `
                <div class="control-card" data-family="${control.family}" data-type="${control.type}" data-id="${control.id}" data-regulators="${control.regulators.join(',')}" style="position: relative;">
                    <input type="checkbox" onchange="toggleSelection('${control.id}')" id="check-${control.id}">
                    <div class="control-header">
                        <span class="control-id">${control.id}</span>
                        <span class="control-family">${control.family}</span>
                    </div>
                    <div class="control-title">${control.title}</div>
                    <div class="control-domain">üìÇ ${control.domain}</div>
                    <div class="control-meta">
                        <span class="meta-tag type-${control.type.toLowerCase()}">${control.type}</span>
                        <span class="meta-tag">üë§ ${control.owner_role}</span>
                        <span class="meta-tag">üìÖ ${control.review_frequency}</span>
                        <span class="meta-tag">üìä ${control.expected_evidence} evidence items</span>
                    </div>
                    <div class="instruments-list">
                        ${control.instruments.map(i => `<span class="instrument-badge">${i}</span>`).join('')}
                    </div>
                    <div class="regulators-list">
                        ${control.regulators.map(r => `<span class="regulator-badge">${r}</span>`).join('')}
                    </div>
                </div>
            `).join('');
        }

        // Toggle selection
        function toggleSelection(controlId) {
            const card = document.querySelector(`[data-id="${controlId}"]`);
            const checkbox = document.getElementById(`check-${controlId}`);
            
            if (checkbox.checked) {
                selectedControls.add(controlId);
                card.classList.add('selected');
            } else {
                selectedControls.delete(controlId);
                card.classList.remove('selected');
            }
            
            updateSelectionToolbar();
        }

        // Update selection toolbar
        function updateSelectionToolbar() {
            const toolbar = document.getElementById('selectionToolbar');
            const count = document.getElementById('selectionCount');
            count.innerHTML = `<strong>${selectedControls.size}</strong> control${selectedControls.size !== 1 ? 's' : ''} selected`;
            
            if (selectedControls.size > 0) {
                toolbar.classList.add('active');
            } else {
                toolbar.classList.remove('active');
            }
        }

        // Select all
        function selectAll() {
            const visibleCards = Array.from(document.querySelectorAll('.control-card')).filter(card => card.style.display !== 'none');
            visibleCards.forEach(card => {
                const id = card.dataset.id;
                const checkbox = document.getElementById(`check-${id}`);
                checkbox.checked = true;
                card.classList.add('selected');
                selectedControls.add(id);
            });
            updateSelectionToolbar();
        }

        // Deselect all
        function deselectAll() {
            document.querySelectorAll('.control-card input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            document.querySelectorAll('.control-card').forEach(card => {
                card.classList.remove('selected');
            });
            selectedControls.clear();
            updateSelectionToolbar();
        }

        // Sort controls
        function sortControls() {
            const sortBy = document.getElementById('sortControl').value;
            if (!sortBy) return;

            const container = document.getElementById('controlsList');
            const cards = Array.from(container.children);
            
            cards.sort((a, b) => {
                let aVal, bVal;
                
                if (sortBy === 'id') {
                    aVal = a.dataset.id;
                    bVal = b.dataset.id;
                } else if (sortBy === 'family') {
                    aVal = a.dataset.family;
                    bVal = b.dataset.family;
                } else if (sortBy === 'type') {
                    aVal = a.dataset.type;
                    bVal = b.dataset.type;
                } else if (sortBy === 'title') {
                    aVal = a.querySelector('.control-title').textContent;
                    bVal = b.querySelector('.control-title').textContent;
                }
                
                return aVal.localeCompare(bVal);
            });
            
            container.innerHTML = '';
            cards.forEach(card => container.appendChild(card));
        }

        // Filter controls
        function filterControls() {
            const searchTerm = document.getElementById('controlSearch').value.toLowerCase();
            
            const cards = document.querySelectorAll('.control-card');
            let visibleCount = 0;
            
            cards.forEach(card => {
                const text = card.textContent.toLowerCase();
                const family = card.dataset.family;
                const type = card.dataset.type;
                const regulators = card.dataset.regulators.split(',');
                
                const matchesSearch = text.includes(searchTerm);
                const matchesFamily = activeFilters.families.size === 0 || activeFilters.families.has(family);
                const matchesType = activeFilters.types.size === 0 || activeFilters.types.has(type);
                const matchesRegulator = activeFilters.regulators.size === 0 || 
                                        regulators.some(r => activeFilters.regulators.has(r));
                
                const isVisible = matchesSearch && matchesFamily && matchesType && matchesRegulator;
                card.style.display = isVisible ? 'block' : 'none';
                if (isVisible) visibleCount++;
            });
        }

        // Render evidence table
        function renderEvidence() {
            const tbody = document.getElementById('evidenceTableBody');
            tbody.innerHTML = evidenceData.map(evidence => `
                <tr data-type="${evidence.type}" data-regulator="${evidence.regulator}">
                    <td><strong>${evidence.id}</strong></td>
                    <td>${evidence.title}</td>
                    <td><span class="control-id" style="font-size: 12px;">${evidence.control}</span></td>
                    <td><span class="type-badge ${evidence.type === 'Policy' ? 'type-preventive' : 'type-detective'}">${evidence.type}</span></td>
                    <td><span class="regulator-badge">${evidence.regulator}</span></td>
                    <td><span class="instrument-badge">${evidence.instrument}</span></td>
                    <td>${evidence.owner}</td>
                </tr>
            `).join('');
        }

        // Filter evidence
        function filterEvidence() {
            const searchTerm = document.getElementById('evidenceSearch').value.toLowerCase();
            const typeFilter = document.getElementById('evidenceTypeFilter').value;
            const regulatorFilter = document.getElementById('evidenceRegulatorFilter').value;
            
            const rows = document.querySelectorAll('#evidenceTableBody tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                const type = row.getAttribute('data-type');
                const regulator = row.getAttribute('data-regulator');
                
                const matchesSearch = text.includes(searchTerm);
                const matchesType = !typeFilter || type === typeFilter;
                const matchesRegulator = !regulatorFilter || regulator === regulatorFilter;
                
                row.style.display = (matchesSearch && matchesType && matchesRegulator) ? '' : 'none';
            });
        }

        // Render domains
        function renderDomains() {
            const container = document.getElementById('domainsList');
            const domainControls = {};
            
            checklistData.controls.forEach(control => {
                if (!domainControls[control.family]) {
                    domainControls[control.family] = [];
                }
                domainControls[control.family].push(control);
            });
            
            container.innerHTML = Object.keys(domainControls).map(family => `
                <div class="domain-section">
                    <div class="domain-header">
                        <div class="domain-title">${family} - ${checklistData.meta.domains[family]}</div>
                        <div class="domain-count">${domainControls[family].length} Controls</div>
                    </div>
                    <div class="controls-grid">
                        ${domainControls[family].map(control => `
                            <div class="control-card">
                                <div class="control-header">
                                    <span class="control-id">${control.id}</span>
                                    <span class="type-badge type-${control.type.toLowerCase()}">${control.type}</span>
                                </div>
                                <div class="control-title">${control.title}</div>
                                <div class="control-meta">
                                    <span class="meta-tag">üë§ ${control.owner_role}</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        // Render regulators
        function renderRegulators() {
            const container = document.getElementById('regulatorsList');
            const regulators = checklistData.meta.regulators;
            
            container.innerHTML = Object.keys(regulators).map(key => {
                const controlsForRegulator = checklistData.controls.filter(c => c.regulators.includes(key));
                return `
                    <div class="regulator-section">
                        <div class="regulator-name">${key}</div>
                        <div class="regulator-desc">${regulators[key]}</div>
                        <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; margin-top: 15px;">
                            <strong>Controls: </strong>${controlsForRegulator.length} total
                            <div style="margin-top: 10px;">
                                ${controlsForRegulator.map(c => `<span class="control-id" style="margin-right: 8px; font-size: 12px;">${c.id}</span>`).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Render instruments
        function renderInstruments() {
            const container = document.getElementById('instrumentsList');
            const instruments = checklistData.meta.instruments;
            
            container.innerHTML = `
                <div class="instrument-list">
                    ${Object.keys(instruments).map(key => `
                        <div class="instrument-item">
                            <span class="instrument-code">${key}</span>
                            <span>${instruments[key]}</span>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Render mapping
        function renderMapping() {
            const container = document.getElementById('mappingView');
            
            container.innerHTML = checklistData.controls.map(control => {
                const evidences = evidenceData.filter(e => e.control === control.id);
                return `
                    <div class="domain-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <div>
                                <span class="control-id" style="margin-right: 10px;">${control.id}</span>
                                <strong>${control.title}</strong>
                            </div>
                            <span class="meta-tag">${evidences.length} evidence items</span>
                        </div>
                        <div style="display: grid; gap: 10px; margin-left: 30px;">
                            ${evidences.map(e => `
                                <div style="background: #f9f9f9; padding: 12px; border-radius: 8px; border-left: 3px solid #667eea;">
                                    <strong>${e.id}:</strong> ${e.title}
                                    <div style="margin-top: 5px; font-size: 13px; color: #666;">
                                        <span class="type-badge ${e.type === 'Policy' ? 'type-preventive' : 'type-detective'}">${e.type}</span>
                                        <span class="regulator-badge" style="margin-left: 10px;">${e.regulator}</span>
                                        <span class="instrument-badge" style="margin-left: 10px;">${e.instrument}</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Sort evidence table
        function sortEvidenceTable(columnIndex) {
            const table = document.getElementById('evidenceTable');
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            const th = table.querySelectorAll('th')[columnIndex];
            
            // Toggle sort direction
            const currentDir = sortDirection[columnIndex] || 'none';
            const newDir = currentDir === 'asc' ? 'desc' : 'asc';
            sortDirection[columnIndex] = newDir;
            
            // Clear other headers
            table.querySelectorAll('th').forEach(h => {
                h.classList.remove('asc', 'desc');
            });
            th.classList.add(newDir);
            
            // Sort rows
            rows.sort((a, b) => {
                const aText = a.cells[columnIndex].textContent.trim();
                const bText = b.cells[columnIndex].textContent.trim();
                
                const comparison = aText.localeCompare(bText);
                return newDir === 'asc' ? comparison : -comparison;
            });
            
            // Re-append rows
            tbody.innerHTML = '';
            rows.forEach(row => tbody.appendChild(row));
        }

        // Export functions
        function toggleExportMenu() {
            const dropdown = document.getElementById('exportDropdown');
            dropdown.classList.toggle('show');
        }

        function exportSelected(format) {
            const selected = Array.from(selectedControls).map(id => 
                checklistData.controls.find(c => c.id === id)
            );
            
            let content = '';
            let filename = '';
            let mimeType = '';
            
            if (format === 'json') {
                content = JSON.stringify(selected, null, 2);
                filename = `selected_controls_${new Date().toISOString().split('T')[0]}.json`;
                mimeType = 'application/json';
            } else if (format === 'csv') {
                const headers = ['ID', 'Family', 'Title', 'Domain', 'Type', 'Instruments', 'Regulators'];
                const csvRows = [headers.join(',')];
                selected.forEach(c => {
                    csvRows.push([
                        c.id,
                        c.family,
                        `"${c.title}"`,
                        `"${c.domain}"`,
                        c.type,
                        `"${c.instruments.join('; ')}"`,
                        `"${c.regulators.join('; ')}"`
                    ].join(','));
                });
                content = csvRows.join('\n');
                filename = `selected_controls_${new Date().toISOString().split('T')[0]}.csv`;
                mimeType = 'text/csv';
            } else if (format === 'txt') {
                content = selected.map(c => `
${c.id} - ${c.title}
Family: ${c.family}
Domain: ${c.domain}
Type: ${c.type}
Instruments: ${c.instruments.join(', ')}
Regulators: ${c.regulators.join(', ')}
Owner: ${c.owner_role}
Review Frequency: ${c.review_frequency}
---
                `).join('\n');
                filename = `selected_controls_${new Date().toISOString().split('T')[0]}.txt`;
                mimeType = 'text/plain';
            }
            
            downloadFile(content, filename, mimeType);
            document.getElementById('exportDropdown').classList.remove('show');
        }

        function exportEvidence() {
            const rows = Array.from(document.querySelectorAll('#evidenceTableBody tr:not([style*="display: none"])'));
            const headers = ['Evidence ID', 'Title', 'Control ID', 'Type', 'Regulator', 'Instrument', 'Owner'];
            const csvRows = [headers.join(',')];
            
            rows.forEach(row => {
                const cells = Array.from(row.cells);
                const rowData = cells.map(cell => `"${cell.textContent.trim()}"`);
                csvRows.push(rowData.join(','));
            });
            
            const content = csvRows.join('\n');
            const filename = `evidence_catalog_${new Date().toISOString().split('T')[0]}.csv`;
            downloadFile(content, filename, 'text/csv');
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Compare selected controls
        function compareSelected() {
            if (selectedControls.size < 2) {
                alert('Please select at least 2 controls to compare');
                return;
            }
            
            const selected = Array.from(selectedControls).map(id => 
                checklistData.controls.find(c => c.id === id)
            );
            
            let comparison = `
<div class="domain-section">
    <h3>Control Comparison (${selected.length} controls)</h3>
    <table class="evidence-table" style="margin-top: 20px;">
        <thead>
            <tr>
                <th>Attribute</th>
                ${selected.map(c => `<th>${c.id}</th>`).join('')}
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><strong>Title</strong></td>
                ${selected.map(c => `<td>${c.title}</td>`).join('')}
            </tr>
            <tr>
                <td><strong>Family</strong></td>
                ${selected.map(c => `<td><span class="control-family">${c.family}</span></td>`).join('')}
            </tr>
            <tr>
                <td><strong>Type</strong></td>
                ${selected.map(c => `<td><span class="type-badge type-${c.type.toLowerCase()}">${c.type}</span></td>`).join('')}
            </tr>
            <tr>
                <td><strong>Domain</strong></td>
                ${selected.map(c => `<td>${c.domain}</td>`).join('')}
            </tr>
            <tr>
                <td><strong>Regulators</strong></td>
                ${selected.map(c => `<td>${c.regulators.map(r => `<span class="regulator-badge">${r}</span>`).join(' ')}</td>`).join('')}
            </tr>
            <tr>
                <td><strong>Instruments</strong></td>
                ${selected.map(c => `<td>${c.instruments.map(i => `<span class="instrument-badge">${i}</span>`).join(' ')}</td>`).join('')}
            </tr>
            <tr>
                <td><strong>Owner</strong></td>
                ${selected.map(c => `<td>${c.owner_role}</td>`).join('')}
            </tr>
            <tr>
                <td><strong>Review Frequency</strong></td>
                ${selected.map(c => `<td>${c.review_frequency}</td>`).join('')}
            </tr>
            <tr>
                <td><strong>Evidence Items</strong></td>
                ${selected.map(c => `<td>${c.expected_evidence}</td>`).join('')}
            </tr>
        </tbody>
    </table>
</div>
            `;
            
            const newWindow = window.open('', '_blank', 'width=1200,height=800');
            newWindow.document.write(`
                <html>
                <head>
                    <title>Control Comparison</title>
                    <style>
                        body { font-family: 'Segoe UI', sans-serif; padding: 20px; }
                        table { width: 100%; border-collapse: collapse; }
                        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
                        th { background: #667eea; color: white; }
                        .control-family { background: #f0f0f0; padding: 5px 15px; border-radius: 20px; font-size: 12px; }
                        .type-badge { padding: 4px 10px; border-radius: 12px; font-size: 12px; }
                        .type-preventive { background: #c8e6c9; color: #2e7d32; }
                        .type-detective { background: #fff9c4; color: #f57f17; }
                        .type-corrective { background: #ffccbc; color: #d84315; }
                        .regulator-badge { background: #fff3e0; color: #e65100; padding: 4px 10px; border-radius: 12px; font-size: 12px; margin: 2px; display: inline-block; }
                        .instrument-badge { background: #e3f2fd; color: #1976d2; padding: 4px 10px; border-radius: 12px; font-size: 12px; margin: 2px; display: inline-block; }
                    </style>
                </head>
                <body>${comparison}</body>
                </html>
            `);
        }

        // Pivot table functionality
        function updatePivot() {
            const dimension = document.getElementById('pivotDimension').value;
            const metric = document.getElementById('pivotMetric').value;
            const container = document.getElementById('pivotResults');
            
            let pivotData = {};
            
            // Calculate pivot data
            checklistData.controls.forEach(control => {
                let key;
                
                if (dimension === 'family') {
                    key = control.family;
                } else if (dimension === 'type') {
                    key = control.type;
                } else if (dimension === 'regulator') {
                    control.regulators.forEach(reg => {
                        if (!pivotData[reg]) pivotData[reg] = { count: 0, evidence: 0 };
                        pivotData[reg].count++;
                        pivotData[reg].evidence += control.expected_evidence;
                    });
                    return;
                } else if (dimension === 'instrument') {
                    control.instruments.forEach(inst => {
                        if (!pivotData[inst]) pivotData[inst] = { count: 0, evidence: 0 };
                        pivotData[inst].count++;
                        pivotData[inst].evidence += control.expected_evidence;
                    });
                    return;
                } else if (dimension === 'owner') {
                    key = control.owner_role;
                }
                
                if (dimension !== 'regulator' && dimension !== 'instrument') {
                    if (!pivotData[key]) pivotData[key] = { count: 0, evidence: 0 };
                    pivotData[key].count++;
                    pivotData[key].evidence += control.expected_evidence;
                }
            });
            
            // Calculate totals for percentages
            const total = Object.values(pivotData).reduce((sum, val) => sum + val.count, 0);
            
            // Render pivot cards
            container.innerHTML = `
                <div class="pivot-grid">
                    ${Object.keys(pivotData).sort().map(key => {
                        const data = pivotData[key];
                        let value, sublabel;
                        
                        if (metric === 'count') {
                            value = data.count;
                            sublabel = `${data.count} control${data.count !== 1 ? 's' : ''}`;
                        } else if (metric === 'evidence') {
                            value = data.evidence;
                            sublabel = `${data.evidence} evidence item${data.evidence !== 1 ? 's' : ''}`;
                        } else if (metric === 'percentage') {
                            value = ((data.count / total) * 100).toFixed(1) + '%';
                            sublabel = `${data.count} of ${total} controls`;
                        }
                        
                        return `
                            <div class="pivot-card">
                                <div class="pivot-label">${key}</div>
                                <div class="pivot-value">${value}</div>
                                <div class="pivot-sublabel">${sublabel}</div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function exportPivot() {
            const dimension = document.getElementById('pivotDimension').value;
            const metric = document.getElementById('pivotMetric').value;
            
            alert(`Pivot export functionality for ${dimension} by ${metric} would download a comprehensive analysis report.`);
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.matches('.toolbar-btn')) {
                const dropdown = document.getElementById('exportDropdown');
                if (dropdown && dropdown.classList.contains('show')) {
                    dropdown.classList.remove('show');
                }
            }
        });
    </script>
</body>
</html>

